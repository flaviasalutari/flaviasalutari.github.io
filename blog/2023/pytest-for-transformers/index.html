<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Harnessing the magic of pytest and mocking for transformers models</title>
<meta name="description" content="The landscape of Natural Language Processing (NLP) has undergone a dramatic transformation with the advent of transformers models. Powered by Hugging Face’s ...">


<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="https://flaviasalutari.github.io//blog/2023/pytest-for-transformers/">
<link rel="alternate" type="application/rss+xml" title="Flavia Salutari's Website" href="https://flaviasalutari.github.io//feed.xml" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52446115-1', 'auto');
  ga('send', 'pageview');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/">flavia<span>salutari</span> <small></small></a></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
          <li><a href="/teaching" title="Teaching">Teaching</a></li>
        
          <li><a href="/publications" title="Publications">Publications</a></li>
        
        <li><a href="http://flaviasalutari.github.io/resume">Resume</a></li>
<!--         <li><a href="https://github.com/flaviasalutari/flaviasalutari.github.io/archive/master.zip" title="Download">Resume</a></li>
 -->        
 <!-- <li><a href="/feed.xml" target="_blank"><i class="icon icon-rss"></i></a></li> -->
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Harnessing the magic of pytest and mocking for transformers models</h1>
      <em class="post-meta">
        <time>Mar 11, 2023</time>
      </em>
    </header>

    <div class="post-content">
      
        <figure class="post-thumbnail ">
          <img src="/images/boris/magician.jpeg" alt="Harnessing the magic of pytest and mocking for transformers models">
        </figure>
      
      <p>The landscape of Natural Language Processing (NLP) has undergone a dramatic transformation with the advent of transformers models. Powered by Hugging Face’s popular Transformers library, these sophisticated models have ushered in a new era of AI applications, from language translation to sentiment analysis and beyond.</p>

<p>As the prominence of transformers models continues to grow, the need for rigorous testing methodologies becomes paramount. In this blog post, we will explore the vital role of testing in the world of NLP and AI development, focusing specifically on transformers models.</p>

<p>While <code>pytest</code> simplifies testing, real transformers models can be challenging, due to their resource-intensive nature. Loading large models and processing vast amounts of data can slow down test cycles. This is where the art of mocking with <code>unittest.mock</code> comes into play. 
By creating lightweight and simulated versions of models, we can substitute time-consuming operations with mocked objects, achieving faster and more focused testing. This allows us to confidently validate the behavior of our model without being blocked by resource constraints.</p>

<h2 id="2-understanding-pytest">2. Understanding Pytest</h2>

<h3 id="what-is-pytest">What is Pytest?</h3>

<p><code>Pytest</code> is a feature-rich and widely-used testing framework in Python. Known for its simplicity and ease of use, it allows to write tests using a clean and intuitive syntax. It automatically discovers and runs all the test functions within your codebase, making testing effortless and efficient.</p>

<h3 id="getting-started-with-pytest">Getting Started with Pytest</h3>

<p>To use Pytest in your project, you need to install it via pip:</p>

<pre><code class="language-shell">pip install pytest
</code></pre>

<p>Create a file with test functions and name it <code>test_*.py</code>. <code>Pytest</code> will automatically recognize this file as containing test functions.</p>

<p>A simple test function using <code>pytest</code> looks like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># test_example.py</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">test_add</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">5</span></code></pre></figure>

<p>Running Pytest will automatically discover and run the test functions:</p>

<pre><code class="language-shell">pytest
</code></pre>

<h2 id="3-mocking-transformers-models">3. Mocking Transformers Models</h2>

<h3 id="why-mocking-transformers-models">Why mocking Transformers Models?</h3>
<p>Testing transformers models often involves time-consuming tasks, such as loading large models and processing data. Mocking allows us to replace these time-consuming operations with lightweight, simulated versions. This speeds up the test execution and allows us to focus on the functionality of the code being tested.</p>

<h3 id="using-unittestmock-for-mocking">Using <code>unittest.mock</code> for Mocking</h3>
<p>The <code>unittest.mock</code> module in Python provides the tools for creating mock objects. Mocking models, tokenizers, and other dependencies can be done easily using it. Here’s an example of how to mock a transformers model for sentiment analysis.</p>

<p>Let’s begin by creating a basic <code>SentimentAnalysisModel</code> wrapper class that encapsulates a transformers model for sentiment analysis, providing a simple interface for predicting the sentiment of input texts.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># my_transformers_model.py</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForSequenceClassification</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">class</span> <span class="nc">SentimentAnalysisModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;nlptown/bert-base-multilingual-uncased-sentiment&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;nlptown/bert-base-multilingual-uncased-sentiment&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">predict_sentiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">return_tensors</span> <span class="o">=</span> <span class="s1">&#39;pt&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">logits</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="s2">&quot;positive&quot;</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;negative&quot;</span></code></pre></figure>

<h3 id="testing-sentiment-analysis-function">Testing Sentiment Analysis Function</h3>
<p>Now, let’s create a function in <code>my_sentiment_analysis.py</code> that uses the transformers model previously created for sentiment analysis:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># my_sentiment_analysis.py</span>
<span class="kn">from</span> <span class="nn">my_transformers_model</span> <span class="kn">import</span> <span class="n">SentimentAnalysisModel</span>


<span class="k">def</span> <span class="nf">analyze_sentiment</span><span class="p">(</span><span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SentimentAnalysisModel</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></code></pre></figure>

<h3 id="pytest-test-functions">Pytest Test Functions</h3>
<p>With the <code>analyze_sentiment()</code> function and the <code>SentimentAnalysisModel</code> class in place, let’s write the Pytest test functions in <code>test_my_sentiment_analysis.py</code>:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># test_my_sentiment_analysis.py</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">import</span> <span class="nn">my_sentiment_analysis</span>


<span class="k">def</span> <span class="nf">test_analyze_sentiment</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">input_text</span> <span class="o">=</span> <span class="s2">&quot;I love this product! It&#39;s amazing.&quot;</span>
    <span class="n">expected_result</span> <span class="o">=</span> <span class="s2">&quot;positive&quot;</span>

    <span class="c1"># Create a mock model for testing</span>
    <span class="n">mock_model</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">mock_model</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;positive&quot;</span>

    <span class="c1"># Mock the SentimentAnalysisModel class</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
        <span class="n">my_sentiment_analysis</span><span class="o">.</span><span class="n">SentimentAnalysisModel</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
            <span class="n">my_sentiment_analysis</span><span class="o">.</span><span class="n">SentimentAnalysisModel</span><span class="p">,</span>
            <span class="s2">&quot;predict_sentiment&quot;</span><span class="p">,</span>
            <span class="n">return_value</span><span class="o">=</span><span class="n">mock_model</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(),</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">mocked_predict</span><span class="p">:</span>
            <span class="c1"># Test the function that uses the transformers model</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">my_sentiment_analysis</span><span class="o">.</span><span class="n">analyze_sentiment</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="c1"># Assertion</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_result</span>
    <span class="n">mocked_predict</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>


<span class="c1"># Provide test cases with different inputs and expected outputs</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;input_text, expected_result&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;I love it, it is amazing.&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;This movie was terrible.&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Neutral statement.&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_analyze_sentiment_multiple_cases</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">expected_result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">my_sentiment_analysis</span><span class="o">.</span><span class="n">analyze_sentiment</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_result</span></code></pre></figure>

<p>In the <code>test_analyze_sentiment()</code> function, we use the <code>mock.patch.object</code> context manager to mock the <code>SentimentAnalysisModel</code> class and its methods. We set <code>return_value</code> for the mock model to return “positive” as the predicted sentiment. This allows us to test the <code>analyze_sentiment()</code> function with a mocked version of the model.</p>

<p>By using <code>mock.patch.object</code>, we don’t need to replace the original class with the mock; instead, the mock is temporarily applied within the context and reverted back afterward. This approach makes the code cleaner and ensures that the mock doesn’t interfere with other tests. The <code>analyze_sentiment()</code> function can be thoroughly tested using the mock model without accessing any external resources or running the actual model.</p>

<p>The <code>test_analyze_sentiment_multiple_cases()</code> function instead demonstrates parametrized testing, allowing us to test the <code>analyze_sentiment()</code> function with multiple inputs and expected outputs. Unlike the previous test function (<code>test_analyze_sentiment</code>) that used mocking to replace the real model, here we employ the actual sentiment analysis model defined in <code>my_transformers_model.py</code>. This means that the sentiment analysis is performed using the real model and not a mocked version. The test cases cover various sentiments, ensuring that the function behaves correctly for different scenarios.</p>

<h2 id="4-conclusion">4. Conclusion</h2>

<p>Testing transformers models is crucial for ensuring their reliability and correctness. By leveraging <code>Pytest</code> and <code>unittest.mock</code> module for mocking, we can write comprehensive and efficient tests for them. Mocking the transformers model allows us to isolate the tests from time-consuming operations, leading to faster testing.</p>

<p>With well-structured test functions and parametrized tests, we can thoroughly evaluate the behavior and performance of the sentiment analysis function without running the actual model. As I continue my journey in NLP and AI development, mastering <code>Pytest</code> and mocking will enable me to deliver robust and reliable transformers models that excel in real-world applications. Happy testing!</p>


    </div>

    
<hr>

<aside id="comments" class="disqus">
  <h3><i class="icon icon-comments-o"></i> Comments</h3>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://flaviasalutari.github.io//blog/2023/pytest-for-transformers/';
      this.page.identifier = '/blog/2023/pytest-for-transformers';
    };
    (function() {
      var d = document,
      s = d.createElement('script');
      s.src = '//flaviasalutari.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</aside>


  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">


  <li><a href="https://github.com/flaviasalutari" target="_blank"><i class="icon icon-github"></i></a></li>
  <!-- <li><a href="https://twitter.com/fsalutari" target="_blank"><i class="icon icon-twitter"></i></a></li> -->
<!--   <li><a href="" target="_blank"><i class="icon icon-facebook"></i></a></li>-->  
<li><a href="https://www.linkedin.com/in/flaviasalutari/" target="_blank"><i class="icon icon-linkedin"></i></a></li>
<li><a href="/assets/flaviasalutariCV_eng_2023.pdf" target="_blank"><i class="icon icon-cloud-download"></i></a></li>
<li><a href="https://scholar.google.fr/citations?user=vfZgNcwAAAAJ&hl" target="_blank"><i class="icon icon-pencil"></i></a></li>
<br><li><a href="/indit"><img src="https://flaviasalutari.github.io//assets/flagit.png" width="30" height="20"></a></li>
<li><a href="/indfr"><img src="https://flaviasalutari.github.io//assets/flagfr.png" width="30" height="20"></a></li>

</ul>
    <p class="txt-medium-gray">
      <small>&copy;2024 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
  

</footer>


<script>
$(document).ready(function(){
    var str =$(this).attr('id');
    
    $(".btnId").click(function(){
        var str = $(this).attr('id');
        var ret = str.split("_");
        var id = ret[1];
        $('#' + id).toggle();
    });
});
</script>


<!--   <a href="https://github.com/flaviasalutari/flaviasalutari.github.io" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
 -->
 	
 </body>
</html>
